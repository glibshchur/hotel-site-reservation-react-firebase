{"ast":null,"code":"import _defineProperty from \"/Users/hshchu/Desktop/github/e-commerce/node_modules/@babel/runtime/helpers/esm/defineProperty\";\nimport _slicedToArray from \"/Users/hshchu/Desktop/github/e-commerce/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\nvar _jsxFileName = \"/Users/hshchu/Desktop/github/e-commerce/src/components/Product/List/index.js\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nimport React, { useEffect, useState, useRef } from 'react';\nimport { makeStyles } from '@material-ui/core/styles';\nimport { compose } from 'recompose';\nimport { withFirebase } from '../../Firebase';\nimport { withAuthentication, withAuthorization, AuthUserContext } from '../../Session';\nimport { Grid, Typography } from '@material-ui/core';\nimport ProductListItem from './ProductListItem';\nimport NullImage from '../No-Image-Available.jpg';\nimport NewItem from './NewItem';\nconst useStyles = makeStyles(theme => ({\n  root: {\n    flexGrow: 1,\n    width: \"100%\",\n    backgroundColor: \"#EBEBEB\"\n  },\n  menuButton: {\n    marginRight: theme.spacing(2)\n  },\n  header: {\n    width: \"100%\",\n    height: 50,\n    backgroundColor: \"#FAFAFA\"\n  },\n  toolBar: {\n    minHeight: 36,\n    margin: 0,\n    spacing: 0,\n    padding: 0\n  },\n  appBar: {\n    width: \"calc(100% - 225px)\",\n    height: 36,\n    marginLeft: 225,\n    marginTop: 0,\n    backgroundColor: '#BBBBBB'\n  },\n  title: {\n    flexGrow: 1\n  },\n  tempDrawerPaper: {\n    width: 240,\n    marginLeft: 240,\n    marginTop: 65\n  },\n  drawer: {\n    width: 240,\n    flexShrink: 0\n  },\n  drawerPaper: {\n    marginTop: 120,\n    width: 240\n  },\n  content: {\n    marginLeft: 225,\n    flexGrow: 1,\n    backgroundColor: \"#EBEBEB\"\n  },\n  modal: {\n    marginLeft: 150,\n    disableBackdropClick: true,\n    hideBackdrop: true,\n    disableEscapeKeyDown: false\n  },\n  icon: {\n    color: 'rgba(255, 255, 255, 0.54)'\n  },\n  toolbarIcon: {\n    color: '#FFFFFF'\n  },\n  title: {\n    marginLeft: 15,\n    marginTop: 15,\n    fontSize: 18\n  },\n  toolbarButton: {\n    height: \"100%\",\n    minWidth: 45,\n    width: 50,\n    margin: 0,\n    color: '#FFFFFF',\n    borderRadius: 0,\n    '&:hover': {\n      backgroundColor: '#D6D6D6'\n    }\n  },\n  cartButton: {\n    height: \"100%\",\n    width: 100,\n    margin: 0,\n    color: '#FFFFFF',\n    backgroundColor: '#00B4F4',\n    borderRadius: 0,\n    '&:hover': {\n      backgroundColor: '#D6D6D6'\n    }\n  },\n  userProfilePopper: {\n    backgroundColor: '#BBBBBB',\n    borderRadius: 0,\n    margin: 0,\n    spacing: 0,\n    padding: 0\n  },\n  userProfilePopperButton: {\n    height: 40,\n    width: 150,\n    align: 'left',\n    color: '#FFFFFF',\n    borderRadius: 0,\n    '&:hover': {\n      backgroundColor: '#D6D6D6'\n    }\n  },\n  userProfileMenuList: {\n    margin: 0,\n    padding: 0,\n    spacing: 0\n  }\n})); //TODO:[Maintainability] Split up the component\n//TODO:[Optimization] Implement local store caching\n\nconst ListProducts = props => {\n  const classes = useStyles();\n\n  const _React$useState = React.useState([]),\n        _React$useState2 = _slicedToArray(_React$useState, 2),\n        products = _React$useState2[0],\n        setProducts = _React$useState2[1]; // Private products are products with isPublic = false\n  // Private products are visible only to Admin users\n\n\n  const _React$useState3 = React.useState([]),\n        _React$useState4 = _slicedToArray(_React$useState3, 2),\n        privateProducts = _React$useState4[0],\n        setPrivateProducts = _React$useState4[1];\n\n  const _React$useState5 = React.useState(false),\n        _React$useState6 = _slicedToArray(_React$useState5, 2),\n        loading = _React$useState6[0],\n        setLoading = _React$useState6[1]; //Create db ref from the products matching the props categoryId\n\n\n  const productRef = props.firebase.products().orderByChild(\"categoryId\").equalTo(\"\".concat(props.match.params.category, \"/\").concat(props.match.params.subCategory));\n  const storageRef = props.firebase.storage;\n\n  const createDefaultProduct = () => {\n    if (props.match.params.category && props.match.params.subCategory) {\n      props.firebase.createProductWithCategory(props.match.params.category, props.match.params.subCategory);\n    }\n  };\n\n  useEffect(() => {\n    const cr = productRef.on(\"child_removed\", snapshot => {\n      setProducts(e => e.filter(x => x.key !== snapshot.key));\n    });\n    const cc = productRef.on(\"child_changed\", snapshot => {\n      const id = products.findIndex(x => x.key == snapshot.key);\n      console.log(id);\n      console.log(products[id]);\n\n      if (id > -1) {\n        storageRef.ref().child(snapshot.val().previewImage).getDownloadURL().then(url => {\n          let element = _objectSpread({}, snapshot.val(), {\n            imageRef: url,\n            key: snapshot.key\n          });\n\n          console.log(element);\n          let carr = products; // Copy array - Probably a better way to do it\n\n          carr[id] = element;\n          setProducts(a => carr);\n        }).catch(err => console.log(err));\n      }\n    });\n    return () => {\n      productRef.off(\"child_removed\", cr);\n      productRef.off(\"child_changed\", cc);\n    };\n  }, [products]);\n  useEffect(() => {\n    // reset products state\n    setProducts([]);\n    setPrivateProducts([]);\n    const categoryRef = props.firebase.db.ref(\"categories/\".concat(props.match.params.category, \"/subCategories/\").concat(props.match.params.subCategory)).once('value', snapshot => {// if(!snapshot.exists())\n      //   props.history.push('/404')\n    });\n    const ca = productRef.on(\"child_added\", (snapshot, prevChildKey) => {\n      // Try to get url from the storage\n      storageRef.ref().child(snapshot.val().previewImage).getDownloadURL().then(url => {\n        let element = _objectSpread({}, snapshot.val(), {\n          imageRef: url,\n          key: snapshot.key\n        });\n\n        setProducts(a => [...a, element]); // if it fails set the url to the default image\n        // \n      }).catch(err => {\n        let element = _objectSpread({}, snapshot.val(), {\n          key: snapshot.key\n        }); //let element = {...snapshot.val(), imageRef:NullImage, key:snapshot.key}\n\n\n        setProducts(a => [...a, element]);\n      });\n    });\n    return () => {\n      productRef.off(\"child_added\", ca);\n    };\n  }, [props.match.params.category, props.match.params.subCategory]);\n\n  const deleteProduct = uid => {\n    props.firebase.deleteProduct(uid);\n  }; // Store the cart data in browser storage\n  // There's no reason for it to be stored in the db for now\n\n\n  const addItemToCart = product => {\n    let cart = localStorage.getItem('cart');\n    let cartObj = !!cart && !!JSON.parse(cart) ? JSON.parse(cart) : [];\n    let productId = cartObj.findIndex(x => x.key == product.key);\n    if (productId == -1) cartObj.push(product);\n    localStorage.setItem('cart', JSON.stringify(cartObj));\n  };\n\n  if (loading) return React.createElement(\"div\", {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 258\n    },\n    __self: this\n  }, \"Loading\");\n  return React.createElement(\"div\", {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 261\n    },\n    __self: this\n  }, React.createElement(\"div\", {\n    className: classes.header,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 262\n    },\n    __self: this\n  }, React.createElement(Grid, {\n    container: true,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 263\n    },\n    __self: this\n  }, React.createElement(Grid, {\n    item: true,\n    xs: 4,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 264\n    },\n    __self: this\n  }, React.createElement(Typography, {\n    variant: \"h6\",\n    className: classes.title,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 265\n    },\n    __self: this\n  }, props.match.params.category, \" > \", props.match.params.subCategory)), React.createElement(Grid, {\n    item: true,\n    xs: 4,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 269\n    },\n    __self: this\n  }), React.createElement(Grid, {\n    item: true,\n    xs: 4,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 271\n    },\n    __self: this\n  }))), React.createElement(Grid, {\n    container: true,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 275\n    },\n    __self: this\n  }, React.createElement(AuthUserContext.Consumer, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 276\n    },\n    __self: this\n  }, authUser => products.map((p, i) => React.createElement(ProductListItem, {\n    product: p,\n    authUser: authUser,\n    firebase: props.firebase,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 277\n    },\n    __self: this\n  }))), React.createElement(AuthUserContext.Consumer, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 279\n    },\n    __self: this\n  }, authUser => !!authUser && authUser.isAdmin && React.createElement(NewItem, {\n    firebase: props.firebase,\n    category: props.match.params.category,\n    subCategory: props.match.params.subCategory,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 280\n    },\n    __self: this\n  }))));\n};\n\nexport default compose(withFirebase, withAuthentication)(ListProducts);","map":{"version":3,"sources":["/Users/hshchu/Desktop/github/e-commerce/src/components/Product/List/index.js"],"names":["React","useEffect","useState","useRef","makeStyles","compose","withFirebase","withAuthentication","withAuthorization","AuthUserContext","Grid","Typography","ProductListItem","NullImage","NewItem","useStyles","theme","root","flexGrow","width","backgroundColor","menuButton","marginRight","spacing","header","height","toolBar","minHeight","margin","padding","appBar","marginLeft","marginTop","title","tempDrawerPaper","drawer","flexShrink","drawerPaper","content","modal","disableBackdropClick","hideBackdrop","disableEscapeKeyDown","icon","color","toolbarIcon","fontSize","toolbarButton","minWidth","borderRadius","cartButton","userProfilePopper","userProfilePopperButton","align","userProfileMenuList","ListProducts","props","classes","products","setProducts","privateProducts","setPrivateProducts","loading","setLoading","productRef","firebase","orderByChild","equalTo","match","params","category","subCategory","storageRef","storage","createDefaultProduct","createProductWithCategory","cr","on","snapshot","e","filter","x","key","cc","id","findIndex","console","log","ref","child","val","previewImage","getDownloadURL","then","url","element","imageRef","carr","a","catch","err","off","categoryRef","db","once","ca","prevChildKey","deleteProduct","uid","addItemToCart","product","cart","localStorage","getItem","cartObj","JSON","parse","productId","push","setItem","stringify","authUser","map","p","i","isAdmin"],"mappings":"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","sourcesContent":["\nimport React, { useEffect, useState, useRef } from 'react';\nimport { makeStyles } from '@material-ui/core/styles';\nimport { compose } from 'recompose'\nimport { withFirebase } from '../../Firebase';\n\nimport { withAuthentication, withAuthorization, AuthUserContext } from '../../Session';\n\nimport {Grid, Typography} from '@material-ui/core'\nimport ProductListItem from './ProductListItem'\nimport NullImage from '../No-Image-Available.jpg';\nimport NewItem from './NewItem'\n\nconst useStyles = makeStyles(theme => ({\n  root: {\n    flexGrow: 1,\n    width:\"100%\",\n    backgroundColor:\"#EBEBEB\"\n  },\n  menuButton: {\n    marginRight: theme.spacing(2),\n  },\n  header:{\n    width:\"100%\",\n    height:50,\n    backgroundColor:\"#FAFAFA\"\n  },\n  toolBar:{\n    minHeight:36,\n    margin:0,\n    spacing:0,\n    padding:0,\n  },\n  appBar:{\n    width:`calc(100% - 225px)`,\n    height:36,\n    marginLeft:225,\n    marginTop:0,\n    backgroundColor:'#BBBBBB'\n  },\n  title: {\n    flexGrow: 1,\n\n  },\n  tempDrawerPaper:{\n    width:240,\n    marginLeft:240,\n    marginTop:65\n  },\n  drawer:{\n    width:240,\n    flexShrink:0,\n  },\n  drawerPaper:{\n    marginTop:120,\n    width:240\n  },\n  content: {\n    marginLeft:225,\n    flexGrow: 1,\n    backgroundColor:\"#EBEBEB\",\n  },\n  modal: {\n    marginLeft: 150,\n    disableBackdropClick: true,\n    hideBackdrop:true,\n    disableEscapeKeyDown:false\n  },\n  icon: {\n    color: 'rgba(255, 255, 255, 0.54)',\n  },\n\n  toolbarIcon:{\n    color: '#FFFFFF'\n  },\n  title:{\n    marginLeft:15,\n    marginTop:15,\n    fontSize:18,\n  },\n\n  toolbarButton:{\n    height:\"100%\",\n    minWidth:45,\n    width:50,\n    margin:0,\n    color: '#FFFFFF',\n    borderRadius:0,\n    '&:hover':{\n      backgroundColor: '#D6D6D6'\n    }\n  },\n  cartButton:{\n    height:\"100%\",\n    width:100,\n    margin:0,\n    color: '#FFFFFF',\n    backgroundColor: '#00B4F4',\n    borderRadius:0,\n    '&:hover':{\n      backgroundColor: '#D6D6D6'\n    }\n  },\n  userProfilePopper:{\n    backgroundColor: '#BBBBBB',\n    borderRadius:0,\n    margin:0,\n    spacing:0,\n    padding:0,\n  },\n  userProfilePopperButton:{\n    height: 40,\n    width: 150,\n    align: 'left',\n    color: '#FFFFFF',\n    borderRadius:0,\n    '&:hover':{\n      backgroundColor: '#D6D6D6'\n    }\n  },\n  userProfileMenuList:{\n    margin:0,\n    padding:0,\n    spacing:0,\n  }\n\n\n\n}));\n\n//TODO:[Maintainability] Split up the component\n//TODO:[Optimization] Implement local store caching\nconst ListProducts = props => {\n\n  const classes = useStyles();\n\n  const [products, setProducts] = React.useState([]);\n\n  // Private products are products with isPublic = false\n  // Private products are visible only to Admin users\n  const [privateProducts, setPrivateProducts] = React.useState([]);\n\n  const [loading, setLoading] = React.useState(false);\n\n  //Create db ref from the products matching the props categoryId\n  const productRef = \n    props.firebase.products()\n    .orderByChild(\"categoryId\")\n    .equalTo(`${props.match.params.category}/${props.match.params.subCategory}`);\n\n\n  const storageRef = props.firebase.storage;\n\n  const createDefaultProduct = () => {\n    if(props.match.params.category && props.match.params.subCategory){\n      props.firebase.createProductWithCategory(props.match.params.category, props.match.params.subCategory)\n    }\n  }\n\n  useEffect(() => {\n\n    const cr = productRef.on(\"child_removed\", (snapshot) => {\n      setProducts(e => e.filter(x => x.key !== snapshot.key));     \n    })\n\n    const cc = productRef.on(\"child_changed\", (snapshot) => {\n      const id = products.findIndex(x => x.key == snapshot.key);\n\n      console.log(id);\n      console.log(products[id]);\n\n      if(id > -1){\n        storageRef.ref().child(snapshot.val().previewImage).getDownloadURL().then( (url) => {          \n          let element = {...snapshot.val(), imageRef:url, key:snapshot.key}\n          console.log(element);\n          let carr = products; // Copy array - Probably a better way to do it\n          carr[id] = element;\n          setProducts(a => carr);  \n        }).catch(err => console.log(err))\n      }\n\n    })\n\n    return () => {\n      productRef.off(\"child_removed\", cr);\n      productRef.off(\"child_changed\", cc);\n    }\n\n  }, [products])\n\n  useEffect( () => {\n\n    // reset products state\n    setProducts([])\n    setPrivateProducts([]);\n\n    const categoryRef = \n      props.firebase.db\n        .ref(`categories/${props.match.params.category}/subCategories/${props.match.params.subCategory}`)\n        .once('value', snapshot => {\n          // if(!snapshot.exists())\n          //   props.history.push('/404')\n        })\n\n\n    const ca = productRef.on(\"child_added\", (snapshot, prevChildKey) => {\n\n      // Try to get url from the storage\n      storageRef.ref().child(snapshot.val().previewImage).getDownloadURL().then( (url) => { \n\n        let element = {...snapshot.val(), imageRef:url, key:snapshot.key}\n\n\n          setProducts(a => [...a, element])  \n\n\n        // if it fails set the url to the default image\n        // \n      }).catch(err => {\n\n        let element = {...snapshot.val(), key:snapshot.key}\n        //let element = {...snapshot.val(), imageRef:NullImage, key:snapshot.key}\n\n\n          setProducts(a => [...a, element])  \n\n\n      })\n     \n    })\n\n    return () => {\n      productRef.off(\"child_added\", ca);\n    }\n\n  }, [props.match.params.category, props.match.params.subCategory]);\n\n  const deleteProduct = (uid) => {\n    props.firebase.deleteProduct(uid);\n  }\n\n  // Store the cart data in browser storage\n  // There's no reason for it to be stored in the db for now\n  const addItemToCart = (product) => {\n    let cart = localStorage.getItem('cart');\n    let cartObj = !!cart && !!JSON.parse(cart) ? JSON.parse(cart) : [];\n\n\n    let productId = cartObj.findIndex(x => x.key == product.key);\n\n    if(productId == -1)\n      cartObj.push(product);\n\n    localStorage.setItem('cart',  JSON.stringify(cartObj))\n\n  }\n\n  if(loading) return <div>Loading</div>\n\n  return(  \n        <div>\n          <div className={classes.header}>\n            <Grid container>\n              <Grid item xs={4}>\n                <Typography variant=\"h6\" className={classes.title}>\n                  {props.match.params.category} > {props.match.params.subCategory}\n                </Typography>\n              </Grid>\n              <Grid item xs={4}>\n              </Grid>\n              <Grid item xs={4}>\n              </Grid>\n            </Grid>\n          </div>\n          <Grid container>\n            <AuthUserContext.Consumer>\n            {authUser => products.map( (p, i) => <ProductListItem product={p} authUser={authUser} firebase={props.firebase}/>)}\n            </AuthUserContext.Consumer>\n            <AuthUserContext.Consumer>\n            {authUser => !!authUser && authUser.isAdmin && <NewItem firebase={props.firebase} category={props.match.params.category} subCategory={props.match.params.subCategory}/>}\n            </AuthUserContext.Consumer>        \n          </Grid>  \n        </div>\n      );\n}\n\n\nexport default compose(withFirebase, withAuthentication)(ListProducts);"]},"metadata":{},"sourceType":"module"}